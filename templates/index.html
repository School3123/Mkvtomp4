<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent to MP4 Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .status-box { padding: 10px; background-color: #f8f9fa; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="mb-4 text-center">Magnet Downloader & Converter</h1>

    <!-- 1. Magnet Download Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">1. Magnet ダウンロード</div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="text" id="magnetLink" class="form-control" placeholder="magnet:?xt=urn:btih:...">
                <button class="btn btn-primary" onclick="startDownload()">ダウンロード開始</button>
            </div>
            
            <div id="torrentStatus" class="status-box">
                <strong>Status:</strong> <span id="t-status">Idle</span><br>
                <strong>Name:</strong> <span id="t-name">-</span><br>
                <div class="progress mt-2">
                    <div id="t-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Convert Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">2. MP4変換 (H.264)</div>
        <div class="card-body">
            <form id="convertForm">
                <div class="mb-3">
                    <label class="form-label">ファイル選択 (downloadsフォルダ内)</label>
                    <select class="form-select" id="fileSelect">
                        {% for file in files %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% else %}
                            <option disabled>ファイルがありません</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">プリセット (速度 vs 圧縮率)</label>
                        <select class="form-select" id="presetSelect">
                            <option value="ultrafast">Ultrafast (最速・画質低)</option>
                            <option value="superfast">Superfast</option>
                            <option value="veryfast">Veryfast</option>
                            <option value="faster">Faster</option>
                            <option value="fast">Fast</option>
                            <option value="medium" selected>Medium (標準)</option>
                            <option value="slow">Slow</option>
                            <option value="slower">Slower</option>
                            <option value="veryslow">Veryslow (最遅・高圧縮)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">画質 (CRF: 18-28 推奨)</label>
                        <input type="number" class="form-control" id="crfValue" value="23" min="0" max="51">
                    </div>
                </div>

                <button type="button" class="btn btn-success w-100" onclick="startConvert()">変換開始</button>
            </form>

            <div id="convertStatus" class="status-box">
                <strong>Status:</strong> <span id="c-status">Idle</span>
                <div id="convertSpinner" class="spinner-border spinner-border-sm text-success d-none" role="status"></div>
            </div>
        </div>
    </div>

    <!-- 3. Download Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">3. 変換済みファイル ダウンロード</div>
        <div class="card-body">
            <div class="list-group" id="convertedList">
                {% for cfile in converted_files %}
                    <a href="/download/{{ cfile }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        {{ cfile }}
                        <span class="badge bg-primary rounded-pill">Download</span>
                    </a>
                {% else %}
                    <div class="text-muted">変換済みのファイルはまだありません。</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Magnetダウンロード開始
    function startDownload() {
        const magnet = document.getElementById('magnetLink').value;
        if(!magnet) return alert("Magnetリンクを入力してください");

        fetch('/add_magnet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `magnet_link=${encodeURIComponent(magnet)}`
        }).then(res => res.json()).then(data => {
            alert(data.message || data.error);
        });
    }

    // 変換開始
    function startConvert() {
        const file = document.getElementById('fileSelect').value;
        const preset = document.getElementById('presetSelect').value;
        const crf = document.getElementById('crfValue').value;

        if(!file) return alert("ファイルを選択してください（ページをリロードしてリストを更新）");

        fetch('/start_convert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `filename=${encodeURIComponent(file)}&preset=${preset}&crf=${crf}`
        }).then(res => res.json()).then(data => {
            console.log(data);
        });
    }

    // ステータスポーリング (1秒ごとに更新)
    setInterval(() => {
        fetch('/status').then(res => res.json()).then(data => {
            // Torrent Status Update
            document.getElementById('t-status').innerText = data.torrent.status;
            document.getElementById('t-name').innerText = data.torrent.name || "-";
            const prog = data.torrent.progress + "%";
            document.getElementById('t-progress-bar').style.width = prog;
            document.getElementById('t-progress-bar').innerText = prog;

            // Convert Status Update
            const cStatus = data.convert.status;
            document.getElementById('c-status').innerText = cStatus;
            
            const spinner = document.getElementById('convertSpinner');
            if(cStatus === 'converting') {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
                if(cStatus === 'complete' && data.convert.output) {
                    // 完了したらリロードを促すか、JSでリストに追加する実装が理想
                    // ここでは簡易的にステータス表示のみ
                    document.getElementById('c-status').innerText = "Complete! (ページをリロードしてダウンロード)";
                }
            }
        });
    }, 1000);
</script>

</body>
</html>
