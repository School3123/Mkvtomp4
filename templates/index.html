<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent to MP4 Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .status-box { padding: 10px; background-color: #f8f9fa; border-radius: 5px; margin-top: 10px; }
        select option { font-family: monospace; }
        /* „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„ÅÆÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥ */
        .sys-text { font-size: 0.9em; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="mb-4 text-center">Magnet Downloader & Converter</h1>

    <!-- 0. System Resources (NEW) -->
    <div class="card shadow-sm border-info">
        <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center">
            <strong>üñ• System Resources</strong>
            <span class="badge bg-light text-dark" id="cpu-name">Checking...</span>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- CPU -->
                <div class="col-md-6 mb-3">
                    <label class="fw-bold sys-text">CPU Usage <span id="cpu-val" class="float-end">- %</span></label>
                    <div class="progress" style="height: 20px;">
                        <div id="cpu-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <!-- RAM -->
                <div class="col-md-6 mb-3">
                    <label class="fw-bold sys-text">Memory <span id="mem-val" class="float-end">- / - GB</span></label>
                    <div class="progress" style="height: 20px;">
                        <div id="mem-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- GPU Area (ÂãïÁöÑ„Å´ËøΩÂä†) -->
            <div id="gpu-container">
                <!-- GPU„Åå„ÅÇ„ÇãÂ†¥Âêà„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
        </div>
    </div>

    <!-- 1. Magnet Download -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">1. Magnet „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="text" id="magnetLink" class="form-control" placeholder="magnet:?xt=urn:btih:...">
                <button class="btn btn-primary" onclick="startDownload()">„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈñãÂßã</button>
            </div>
            <div id="torrentStatus" class="status-box">
                <strong>Status:</strong> <span id="t-status">Idle</span><br>
                <strong>Name:</strong> <span id="t-name">-</span>
                <div class="progress mt-2">
                    <div id="t-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Convert Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">2. MP4Â§âÊèõ</div>
        <div class="card-body">
            <form id="convertForm">
                <div class="mb-3">
                    <label class="form-label">„Éï„Ç°„Ç§„É´ÈÅ∏Êäû</label>
                    <select class="form-select" id="fileSelect" size="5">
                        {% for file in files %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% else %}
                            <option disabled>„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-bold">„Ç®„É≥„Ç≥„Éº„ÉÄ„Éº</label>
                        <select class="form-select border-success" id="encoderSelect">
                            <option value="libx264" selected>CPU (x264)</option>
                            <option value="h264_nvenc">GPU (NVIDIA NVENC)</option>
                            <option value="h264_qsv">GPU (Intel QSV)</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">„Éó„É™„Çª„ÉÉ„Éà</label>
                        <select class="form-select" id="presetSelect">
                            <option value="ultrafast">Ultrafast</option>
                            <option value="medium" selected>Medium</option>
                            <option value="veryslow">Veryslow</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">ÁîªË≥™ (CRF: 18-28)</label>
                        <input type="number" class="form-control" id="crfValue" value="23">
                    </div>
                </div>
                <button type="button" class="btn btn-success w-100" onclick="startConvert()">Â§âÊèõÈñãÂßã</button>
            </form>
            <div id="convertStatus" class="status-box">
                <strong>Status:</strong> <span id="c-status">Idle</span><br>
                <strong>ETA:</strong> <span id="c-eta" class="text-danger">-</span>
                <div class="progress mt-2">
                    <div id="c-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Download Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">3. Â§âÊèõÊ∏à„Åø„Éï„Ç°„Ç§„É´</div>
        <div class="card-body">
            <div class="list-group" id="convertedList">
                {% for cfile in converted_files %}
                    <a href="/download/{{ cfile }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        {{ cfile }} <span class="badge bg-primary">Download</span>
                    </a>
                {% else %}
                    <div class="text-muted">„Å™„Åó</div>
                {% endfor %}
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-3" onclick="location.reload()">„É™„Çπ„ÉàÊõ¥Êñ∞</button>
        </div>
    </div>
</div>

<script>
    // --- Êó¢Â≠ò„ÅÆÈñ¢Êï∞ (startDownload, startConvert) ---
    function startDownload() {
        const magnet = document.getElementById('magnetLink').value;
        if(!magnet) return alert("Magnet„É™„É≥„ÇØ„ÇíÂÖ•Âäõ");
        fetch('/add_magnet', {
            method: 'POST', 
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
            body: `magnet_link=${encodeURIComponent(magnet)}`
        }).then(r=>r.json()).then(d=>alert(d.message||d.error));
    }

    function startConvert() {
        const file = document.getElementById('fileSelect').value;
        const preset = document.getElementById('presetSelect').value;
        const crf = document.getElementById('crfValue').value;
        const encoder = document.getElementById('encoderSelect').value;
        if(!file) return alert("„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû");
        fetch('/start_convert', {
            method: 'POST', 
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
            body: `filename=${encodeURIComponent(file)}&preset=${preset}&crf=${crf}&encoder=${encoder}`
        }).then(r=>r.json()).then(d=>console.log(d));
    }

    // --- „É°„Ç§„É≥„Éù„Éº„É™„É≥„Ç∞Âá¶ÁêÜ ---
    setInterval(() => {
        // 1. „Çø„Çπ„ÇØÁä∂ÊÖã„ÅÆÂèñÂæó
        fetch('/status').then(res => res.json()).then(data => {
            // Torrent
            document.getElementById('t-status').innerText = data.torrent.status;
            document.getElementById('t-name').innerText = data.torrent.name || "-";
            document.getElementById('t-progress-bar').style.width = data.torrent.progress + "%";
            document.getElementById('t-progress-bar').innerText = data.torrent.progress + "%";
            // Convert
            document.getElementById('c-status').innerText = data.convert.status;
            document.getElementById('c-eta').innerText = data.convert.eta || "-";
            document.getElementById('c-progress-bar').style.width = data.convert.progress + "%";
            document.getElementById('c-progress-bar').innerText = data.convert.progress + "%";
        });

        // 2. „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„ÅÆÂèñÂæó (New)
        fetch('/system_info').then(res => res.json()).then(sys => {
            // CPU
            document.getElementById('cpu-name').innerText = sys.cpu.name || "Unknown CPU";
            document.getElementById('cpu-val').innerText = `${sys.cpu.percent}% (${sys.cpu.freq}MHz)`;
            document.getElementById('cpu-bar').style.width = sys.cpu.percent + "%";
            
            // Memory
            document.getElementById('mem-val').innerText = `${sys.memory.used} / ${sys.memory.total} GB`;
            document.getElementById('mem-bar').style.width = sys.memory.percent + "%";
            document.getElementById('mem-bar').innerText = sys.memory.percent + "%";

            // GPU
            const gpuContainer = document.getElementById('gpu-container');
            if (sys.gpus && sys.gpus.length > 0) {
                let html = '<hr>';
                sys.gpus.forEach((gpu, idx) => {
                    html += `
                    <div class="mb-2">
                        <label class="fw-bold sys-text">GPU ${idx+1}: ${gpu.name} <span class="float-end">${gpu.temp}¬∞C / Load: ${gpu.load}%</span></label>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: ${gpu.load}%"></div>
                        </div>
                        <small class="text-muted">VRAM: ${gpu.memory_used}MB / ${gpu.memory_total}MB</small>
                    </div>`;
                });
                gpuContainer.innerHTML = html;
            } else {
                gpuContainer.innerHTML = '<hr><small class="text-muted">No GPU detected or lib not installed.</small>';
            }
        });
    }, 2000); // 2Áßí„Åî„Å®„Å´Êõ¥Êñ∞
</script>

</body>
</html>
